!function(t,e,n){e[t]=n.call(e),"undefined"!=typeof module&&module.exports?module.exports=e[t]:"function"==typeof define&&define.amd&&define(function(){return e[t]})}("Primus",this,function(){"use strict";function t(){this._events={}}function e(t,e){if(!(t instanceof n)){var r=new Error("Primus#"+e+"'s context should called with a Primus instance");if("function"!=typeof t.listeners||!t.listeners("error").length)throw r;t.emit("error",r)}}function n(e,i){if(!(this instanceof n))return new n(e,i);if("function"!=typeof this.client){var s="The client library has not been compiled correctly, see https://github.com/primus/primus#client-library for more details";return this.critical(new Error(s))}"object"==typeof e?(i=e,e=i.url||i.uri||r):i=i||{};var a=this;i.queueSize="queueSize"in i?i.queueSize:1/0,i.timeout="timeout"in i?i.timeout:1e4,i.reconnect="reconnect"in i?i.reconnect:{},i.ping="ping"in i?i.ping:25e3,i.pong="pong"in i?i.pong:1e4,i.strategy="strategy"in i?i.strategy:[],i.transport="transport"in i?i.transport:{},a.buffer=[],a.writable=!0,a.readable=!0,a.url=a.parse(e||r),a.readyState=n.CLOSED,a.options=i,a.timers={},a.attempt=null,a.socket=null,a.latency=0,a.stamps=0,a.disconnect=!1,a.transport=i.transport,a.transformers={outgoing:[],incoming:[]},"string"==typeof i.strategy&&(i.strategy=i.strategy.split(/\s?\,\s?/g)),!1===i.strategy?i.strategy=[]:i.strategy.length||(i.strategy.push("disconnect","online"),this.authorization||i.strategy.push("timeout")),i.strategy=i.strategy.join(",").toLowerCase(),o||t.call(a),"websockets"in i&&(a.AVOID_WEBSOCKETS=!i.websockets),"network"in i&&(a.NETWORK_EVENTS=i.network),i.manual||(a.timers.open=setTimeout(function(){a.clearTimeout("open").open()},0)),a.initialise(i)}t.prototype.listeners=function(t){return Array.apply(this,this._events[t]||[])},t.prototype.emit=function(t,e,n,r,i,o){if(!this._events||!this._events[t])return!1;var s,a,c=this._events[t],u=c.length,p=arguments.length,h=c[0];if(1===u)switch(h.__EE3_once&&this.removeListener(t,h),p){case 1:h.call(h.__EE3_context||this);break;case 2:h.call(h.__EE3_context||this,e);break;case 3:h.call(h.__EE3_context||this,e,n);break;case 4:h.call(h.__EE3_context||this,e,n,r);break;case 5:h.call(h.__EE3_context||this,e,n,r,i);break;case 6:h.call(h.__EE3_context||this,e,n,r,i,o);break;default:for(a=1,s=new Array(p-1);p>a;a++)s[a-1]=arguments[a];h.apply(h.__EE3_context||this,s)}else{for(a=1,s=new Array(p-1);p>a;a++)s[a-1]=arguments[a];for(a=0;u>a;h=c[++a])h.__EE3_once&&this.removeListener(t,h),h.apply(h.__EE3_context||this,s)}return!0},t.prototype.on=function(t,e,n){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),e.__EE3_context=n,this._events[t].push(e),this},t.prototype.once=function(t,e,n){return e.__EE3_once=!0,this.on(t,e,n)},t.prototype.removeListener=function(t,e){if(!this._events||!this._events[t])return this;for(var n=this._events[t],r=[],i=0,o=n.length;o>i;i++)e&&n[i]!==e&&r.push(n[i]);return this._events[t]=r.length?r:null,this},t.prototype.removeAllListeners=function(t){return this._events?(t?this._events[t]=null:this._events={},this):this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prototype.setMaxListeners=function(){return this};var r;try{r=location.origin?location.origin:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}catch(i){r="http://127.0.0.1"}n.require=function(t){return"function"!=typeof require?void 0:"function"==typeof define&&define.amd?void 0:require(t)};var o,s;try{n.Stream=o=n.require("stream"),s=n.require("url").parse,n.require("util").inherits(n,o)}catch(i){n.Stream=t,n.prototype=new t,s=function(t){var e,n=document.createElement("a"),r={};n.href=t;for(e in n)("string"==typeof n[e]||"number"==typeof n[e])&&(r[e]=n[e]);if(!r.port){var i=(r.href||"").split("/");if(i.length>2){var o=i[2],s=o.lastIndexOf("@");~s&&(o=o.slice(s+1)),i=o.split(":"),2===i.length&&(r.port=i[1])}}if(":"===r.protocol&&(r.protocol=r.href.substr(0,r.href.indexOf(":")+1)),"0"===r.port&&(r.port=""),~r.href.indexOf("@")&&!r.auth){var a=r.protocol.length+2;r.auth=r.href.slice(a,r.href.indexOf(r.pathname,a)).split("@")[0]}return r}}n.OPENING=1,n.CLOSED=2,n.OPEN=3,n.prototype.AVOID_WEBSOCKETS=!1,n.prototype.NETWORK_EVENTS=!1,n.prototype.online=!0;try{(n.prototype.NETWORK_EVENTS="onLine"in navigator&&(window.addEventListener||document.body.attachEvent))&&(navigator.onLine||(n.prototype.online=!1))}catch(i){}if(n.prototype.ark={},n.prototype.plugin=function(t){if(e(this,"plugin"),t)return this.ark[t];var n={};for(t in this.ark)n[t]=this.ark[t];return n},n.prototype.reserved=function(t){return/^(incoming|outgoing)::/.test(t)||t in this.reserved.events},n.prototype.reserved.events={readyStateChange:1,reconnecting:1,reconnect:1,offline:1,timeout:1,online:1,error:1,close:1,open:1,data:1,end:1},n.prototype.initialise=function(t){function e(){o.online&&(o.online=!1,o.emit("offline"),o.end())}function r(){o.online||(o.online=!0,o.emit("online"),~o.options.strategy.indexOf("online")&&o.reconnect())}var i,o=this;o.on("outgoing::open",function(){var t=o.readyState;o.readyState=n.OPENING,t!==n.OPENING&&o.emit("readyStateChange"),i=+new Date}),o.on("incoming::open",function(){o.attempt&&(o.attempt=null),o.writable=!0,o.readable=!0;var t=o.readyState;if(o.readyState=n.OPEN,t!==n.OPEN&&o.emit("readyStateChange"),o.latency=+new Date-i,o.emit("open"),o.clearTimeout("ping","pong").heartbeat(),o.buffer.length){for(var e=0,r=o.buffer.length;r>e;e++)o.write(o.buffer[e]);o.buffer=[]}}),o.on("incoming::pong",function(t){o.online=!0,o.clearTimeout("pong").heartbeat(),o.latency=+new Date-t}),o.on("incoming::error",function(t){var e=o.timers.connect;return o.attempt?o.reconnect():(o.listeners("error").length&&o.emit("error",t),void(e&&(~o.options.strategy.indexOf("timeout")?o.reconnect():o.end())))}),o.on("incoming::data",function(t){o.decoder(t,function(e,n){if(e)return o.listeners("error").length&&o.emit("error",e);if(!o.protocol(n)){for(var r=0,i=o.transformers.incoming.length;i>r;r++){var s={data:n};if(!1===o.transformers.incoming[r].call(o,s))return;n=s.data}o.emit("data",n,t)}})}),o.on("incoming::end",function(){var t=o.readyState;if(o.disconnect)return o.disconnect=!1,o.end();if(o.readyState=n.CLOSED,t!==n.CLOSED&&o.emit("readyStateChange"),o.timers.connect&&o.end(),t===n.OPEN){this.writable=!1,this.readable=!1;for(var e in this.timers)this.clearTimeout(e);if(o.emit("close"),~o.options.strategy.indexOf("disconnect"))return o.reconnect();o.emit("outgoing::end"),o.emit("end")}}),o.client();for(var s in o.ark)o.ark[s].call(o,o,t);return o.NETWORK_EVENTS?(window.addEventListener?(window.addEventListener("offline",e,!1),window.addEventListener("online",r,!1)):document.body.attachEvent&&(document.body.attachEvent("onoffline",e),document.body.attachEvent("ononline",r)),o):o},n.prototype.protocol=function(t){if("string"!=typeof t||0!==t.indexOf("primus::"))return!1;var e=t.indexOf(":",8),n=t.slice(e+2);switch(t.slice(8,e)){case"pong":this.emit("incoming::pong",n);break;case"server":"close"===n&&(this.disconnect=!0);break;case"id":this.emit("incoming::id",n);break;default:return!1}return!0},n.prototype.id=function(t){return this.socket&&this.socket.id?t(this.socket.id):(this.write("primus::id::"),this.once("incoming::id",t))},n.prototype.open=function(){return e(this,"open"),!this.attempt&&this.options.timeout&&this.timeout(),this.emit("outgoing::open")},n.prototype.write=function(t){var r,i=this;if(e(i,"write"),n.OPEN===i.readyState){for(var o=0,s=i.transformers.outgoing.length;s>o;o++){if(r={data:t},!1===i.transformers.outgoing[o].call(i,r))return;t=r.data}i.encoder(t,function(t,e){return t?i.listeners("error").length&&i.emit("error",t):void i.emit("outgoing::data",e)})}else{var a=i.buffer;a.length===i.options.queueSize&&a.splice(0,1),a.push(t)}return!0},n.prototype.heartbeat=function(){function t(){n.clearTimeout("pong"),n.online&&(n.online=!1,n.emit("offline"),n.emit("incoming::end"))}function e(){n.clearTimeout("ping").write("primus::ping::"+ +new Date),n.emit("outgoing::ping"),n.timers.pong=setTimeout(t,n.options.pong)}var n=this;return n.options.ping?void(n.timers.ping=setTimeout(e,n.options.ping)):n},n.prototype.timeout=function(){function t(){e.removeListener("error",t).removeListener("open",t).removeListener("end",t).clearTimeout("connect")}var e=this;return e.timers.connect=setTimeout(function(){t(),e.readyState===n.OPEN||e.attempt||(e.emit("timeout"),~e.options.strategy.indexOf("timeout")?e.reconnect():e.end())},e.options.timeout),e.on("error",t).on("open",t).on("end",t)},n.prototype.clearTimeout=function(){for(var t=arguments,e=0,n=t.length;n>e;e++)this.timers[t[e]]&&clearTimeout(this.timers[t[e]]),delete this.timers[t[e]];return this},n.prototype.backoff=function(t,e){e=e||{};var n=this;return e.backoff?n:(e.maxDelay="maxDelay"in e?e.maxDelay:1/0,e.minDelay="minDelay"in e?e.minDelay:500,e.retries="retries"in e?e.retries:10,e.attempt=(+e.attempt||0)+1,e.factor="factor"in e?e.factor:2,e.attempt>e.retries?(t(new Error("Unable to retry"),e),n):(e.backoff=!0,e.timeout=1!==e.attempt?Math.min(Math.round((Math.random()+1)*e.minDelay*Math.pow(e.factor,e.attempt)),e.maxDelay):e.minDelay,n.timers.reconnect=setTimeout(function(){e.backoff=!1,n.clearTimeout("reconnect"),t(void 0,e)},e.timeout),n.emit("reconnecting",e),n))},n.prototype.reconnect=function(){var t=this;return t.attempt=t.attempt||t.clone(t.options.reconnect),t.backoff(function(e,n){return e?(t.attempt=null,t.emit("end")):(t.emit("reconnect",n),void t.emit("outgoing::reconnect"))},t.attempt),t},n.prototype.end=function(t){if(e(this,"end"),this.readyState===n.CLOSED&&!this.timers.connect)return this.timers.reconnect&&(this.clearTimeout("reconnect"),this.attempt=null,this.emit("end")),this;t&&this.write(t),this.writable=!1,this.readable=!1;var r=this.readyState;this.readyState=n.CLOSED,r!==n.CLOSED&&this.emit("readyStateChange");for(var i in this.timers)this.clearTimeout(i);return this.emit("outgoing::end"),this.emit("close"),this.emit("end"),this},n.prototype.clone=function(t){return this.merge({},t)},n.prototype.merge=function(t){for(var e,n,r=Array.prototype.slice.call(arguments,1),i=0,o=r.length;o>i;i++){n=r[i];for(e in n)n.hasOwnProperty(e)&&(t[e]=n[e])}return t},n.prototype.parse=s,n.prototype.querystring=function(t){for(var e,n=/([^=?&]+)=([^&]*)/g,r={};e=n.exec(t);r[decodeURIComponent(e[1])]=decodeURIComponent(e[2]));return r},n.prototype.querystringify=function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.join("&")},n.prototype.uri=function(t){var e=this.url,n=[],r=!1;t.query&&(r=!0),t=t||{},t.protocol="protocol"in t?t.protocol:"http",t.query=e.search&&"query"in t?"?"===e.search.charAt(0)?e.search.slice(1):e.search:!1,t.secure="secure"in t?t.secure:"https:"===e.protocol||"wss:"===e.protocol,t.auth="auth"in t?t.auth:e.auth,t.pathname="pathname"in t?t.pathname:this.pathname.slice(1),t.port="port"in t?t.port:e.port||(t.secure?443:80),t.host="host"in t?t.host:e.hostname||e.host.replace(":"+e.port,""),this.emit("outgoing::url",t);var i=443!=t.port&&80!=t.port?t.host+":"+t.port:t.host,o=this.querystring(t.query||"");return o._primuscb=+new Date+"-"+this.stamps++,t.query=this.querystringify(o),n.push(t.secure?t.protocol+"s:":t.protocol+":",""),n.push(t.auth?t.auth+"@"+i:i),t.pathname&&n.push(t.pathname),r?n.push("?"+t.query):delete t.query,t.object?t:n.join("/")},n.prototype.emits=function(t,e){var n=this;return function(r){var i=e?e.apply(n,arguments):r;setTimeout(function(){n.emit("incoming::"+t,i)},0)}},n.prototype.transform=function(t,n){return e(this,"transform"),t in this.transformers?(this.transformers[t].push(n),this):this.critical(new Error("Invalid transformer type"))},n.prototype.critical=function(t){if(this.listeners("error").length)return this.emit("error",t),this;throw t},n.connect=function(t,e){return new n(t,e)},n.EventEmitter=t,n.prototype.client=function(){var t,e=this,r=function(){if("undefined"!=typeof WebSocket)return WebSocket;if("undefined"!=typeof MozWebSocket)return MozWebSocket;try{return n.require("ws")}catch(t){}return void 0}();return r?(e.on("outgoing::open",function(){e.emit("outgoing::end");try{var n="ws+unix:"===e.url.protocol?"ws+unix":"ws",i="ws"===n;e.socket=t=3===r.length?new r(e.uri({protocol:n,query:i}),[],e.transport):new r(e.uri({protocol:n,query:i}))}catch(o){return e.emit("error",o)}t.binaryType="arraybuffer",t.onopen=e.emits("open"),t.onerror=e.emits("error"),t.onclose=e.emits("end"),t.onmessage=e.emits("data",function(t){return t.data})}),e.on("outgoing::data",function(n){if(t&&t.readyState===r.OPEN)try{t.send(n)}catch(i){e.emit("incoming::error",i)}}),e.on("outgoing::reconnect",function(){e.emit("outgoing::end"),e.emit("outgoing::open")}),void e.on("outgoing::end",function(){t&&(t.onerror=t.onopen=t.onclose=t.onmessage=function(){},t.close(),t=null)})):e.critical(new Error("Missing required `ws` module. Please run `npm install --save ws`"))},n.prototype.authorization=!0,n.prototype.pathname="/primus",n.prototype.encoder=function(t,e){var n;try{t=JSON.stringify(t)}catch(r){n=r}e(n,t)},n.prototype.decoder=function(t,e){var n;try{t=JSON.parse(t)}catch(r){n=r}e(n,t)},n.prototype.version="2.2.4","object"==typeof JSON&&"function"==typeof JSON.stringify&&'["\u2028\u2029"]'===JSON.stringify(["\u2028\u2029"])&&(JSON.stringify=function(t){var e=/\u2028/g,n=/\u2029/g;return function(r,i,o){var s=t.call(this,r,i,o);return s&&(~s.indexOf("\u2028")&&(s=s.replace(e,"\\u2028")),~s.indexOf("\u2029")&&(s=s.replace(n,"\\u2029"))),s}}(JSON.stringify)),"undefined"!=typeof document&&"undefined"!=typeof navigator){document.addEventListener&&document.addEventListener("keydown",function(t){27===t.keyCode&&t.preventDefault&&t.preventDefault()},!1);var a=(navigator.userAgent||"").toLowerCase(),c=a.match(/.+(?:rv|it|ra|ie)[\/: ](\d+)\.(\d+)(?:\.(\d+))?/)||[],u=+[c[1],c[2]].join(".");!~a.indexOf("chrome")&&~a.indexOf("safari")&&534.54>u&&(n.prototype.AVOID_WEBSOCKETS=!0)}return n.prototype.ark.emitter=function(){},n.prototype.ark.multiplex=function(t){var e=new n.$.multiplex.Multiplex(t);t.channel=function(t){return e.channel(t)}},n}),function(t,e){function n(t,e){"use strict";function n(t){return/^(newListener|removeListener)/.test(t)?this:(this.emitter.send.apply(this.emitter,arguments),this)}var r=t.prototype.initialise;return t.prototype.initialise=function(){this.emitter||(this.emitter=new e(this)),this.__initialise||r.apply(this,arguments)},t.readable?void(t.prototype.send||t.readable("send",n)):t.prototype.send=n}function r(){"use strict";function t(e){return this instanceof t?(this.ids=1,this.acks={},this.conn=e,void(this.conn&&this.bind())):new t(e)}var e={EVENT:0,ACK:1},n=[].slice;return t.prototype.bind=function(){var t=this;return this.conn.on("data",function(e){t.ondata.call(t,e)}),this},t.prototype.ondata=function(t){switch(t.type){case e.EVENT:this.onevent(t);break;case e.ACK:this.onack(t)}},t.prototype.send=function(){var t=n.call(arguments);return this.conn.write(this.packet(t)),this},t.prototype.packet=function(t){var n={type:e.EVENT,data:t};if("function"==typeof t[t.length-1]){var r=this.ids++;this.acks&&(this.acks[r]=t.pop(),n.id=r)}return n},t.prototype.onevent=function(t){var e=t.data||[];return t.id&&e.push(this.ack(t.id)),this.conn.reserved(e[0])?this:(this.conn.emit.apply(this.conn,e),this)},t.prototype.ack=function(t){var r=this.conn,i=!1;return function(){i||r.write({id:t,type:e.ACK,data:n.call(arguments)})}},t.prototype.onack=function(t){var e=this.acks[t.id];return"function"==typeof e?(e.apply(this,t.data),delete this.acks[t.id]):console.log("bad ack %s",t.id),this},t.packets=e,t}e!==t&&(t.$=t.$||{},t.$.emitter={},t.$.emitter.spark=n,t.$.emitter.emitter=r,n(t,r()))}(Primus),function(t,e){function n(){"use strict";function e(t,r,i){return this instanceof e?(n.call(this),this.channel=r,this.id=i||this.uid(13),this.packets=t.packets,this.conn=t.conn,this.readyState=t.conn.readyState,this.channels=t.channels,this.writable=!0,this.readable=!0,this.reconnect=!1,void this.initialise()):new e(t,r,i)}var n,r;try{n=require("stream"),r=process.nextTick}catch(i){n=t.EventEmitter,r=function(t){setTimeout(t,0)}}"undefined"==typeof Object.create&&(Object.create=function(t){function e(){}return e.prototype=t,new e});var o=[].slice,s=["open","error","online","offline","timeout","reconnect","reconnecting","readyStateChange"];return e.prototype=Object.create(n.prototype),e.prototype.constructor=e,e.prototype.initialise=function(){function t(t){function e(){i.emit.apply(i,[t].concat(o.call(arguments)))}i.conn.on(t,e),i.on("end",function(){i.conn.removeListener(t,e)})}function e(){i.readyState=i.conn.readyState}function n(){i.reconnect&&i.connect(),i.reconnect=!1}function r(){i.reconnect=!0}var i=this;i.conn.on("readyStateChange",e),this.connect();for(var a=0;a<s.length;a++)t(s[a]);return i.conn.on("open",n),i.conn.on("reconnect",r),i.on("end",function(){i.conn.removeListener("readyStateChange",e),i.conn.removeListener("open",n),i.conn.removeListener("reconnect",r)}),this},e.prototype.connect=function(){return this.conn.write(this.packet.call(this,"SUBSCRIBE")),this},e.prototype.write=function(t){var e=this.packet("MESSAGE",t);return this.conn.write(e)},e.prototype.end=function(t){var e=this;return t&&this.write(t),this.conn.write(this.packet("UNSUBSCRIBE")),r(function(){e.emit("end"),e.writable=!1}),delete this.channels[this.channel][this.id],this},e.prototype.uid=function(t){return Math.random().toString(35).substr(2,t||7)},e.prototype.packet=function(t,e){var n=this.packets[t],r=[n,this.id,this.channel];return e&&r.push(e),r},e.prototype.reserved=function(t){return/^(incoming|outgoing)::/.test(t)||t in this.conn.reserved.events||t in this.reserved.events},e.prototype.reserved.events={},e}function r(e){"use strict";function n(t,e){return this instanceof n?(e=e||{},this.conn=t,this.channels={},this.reconnect=!1,void(this.conn&&this.bind())):new n(t,e)}function r(t){return"[object Array]"===Object.prototype.toString.call(t)}return n.prototype.packets={MESSAGE:0,SUBSCRIBE:1,UNSUBSCRIBE:2},n.prototype.bind=function(){var t=this;return this.conn.on("data",function(e){if(r(e)){var n=e.shift(),i=e.shift(),o=e.shift(),s=e.shift(),a=t.channels[o][i];if(!a)return!1;switch(n){case t.packets.MESSAGE:a.emit("data",s);break;case t.packets.UNSUBSCRIBE:a.emit("end"),a.removeAllListeners(),delete t.channels[o][i]}return!1}}),this},n.prototype.channel=function(n){if(!n)return this.conn;"emitter"in t.$&&t.$.emitter.spark(e,t.$.emitter.emitter());var r=new e(this,n),i=r.id;return this.channels[n]=this.channels[n]||{},this.channels[n][i]=r,r},n}if(e!==t){var i=n();t.$=t.$||{},t.$.multiplex={},t.$.multiplex.spark=n,t.$.multiplex.multiplex=r,t.$.multiplex.Multiplex=r(i)}}(Primus);